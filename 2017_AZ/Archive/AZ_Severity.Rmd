---
title: "AZ Severity Data"
author: "Katie Gostic"
date: "9/25/2017"
---

Load data

```{r}
rm(list = ls())
setwd('~/Dropbox/R/2017_seasonal_flu/')
ICU.subtype.birthyear = data.frame('H3N2' = c(126, 318, 39, 389), 'H1N1' = c(151, 272, 91, 526), ICU = c(1, 0, 1, 0), pre.1968 = c(1, 1, 0, 0))
```


#ICU admission by subtype, birth year
####For H3N2, we expect the majority of ICU admissions to occur in older age groups, born before 1968

Note, it's difficult to separate the effects of imprinting from age here, as people over age 65 are known to be at higher risk of severe infection, and people over age 65 were all born before 1968

```{r}
H3N2.subtype.birthyear = matrix(ICU.subtype.birthyear$H3N2, 2, 2, dimnames = list(c('ICU', 'no.ICU'), c('pre.1968', 'post.1968')))
H3N2.subtype.birthyear
prop.table(H3N2.subtype.birthyear, margin = 1)
```

####For H1N1, we expect more ICU admissions to occur in younger age groups, born after 1968
Note, again it's difficult to separate the effects of imprinting from age here
```{r}
H1N1.subtype.birthyear = matrix(ICU.subtype.birthyear$H1N1, 2, 2, dimnames = list(c('ICU', 'no.ICU'), c('pre.1968', 'post.1968')))
H1N1.subtype.birthyear

# Proportion of ICU cases or non-ICU cases born before or after 1968
prop.table(H1N1.subtype.birthyear, 1)
c.test = chisq.test(H1N1.subtype.birthyear)
c.test
# Expected counts if birth year and ICU admission outcome are independent
c.test$expected
```



#### Compare the birth year distributions of ICU admissions for H1N1 vs. H3N2
This approach considers only cases admitted to the ICU, thus getting around the expected age differences in ICU vs. non_ICU cases
* If imprinting plays a role, we expect a higher fraction of H3N2-related ICU admissions to occur in pre-1968 birth years, and a higher fraction of H1N1-related ICU admissions to occur in post-1968 cohorts

```{r}
ICU.birthyear = matrix(c(126, 151, 39, 91), 2, 2, dimnames = list(c('H3', 'H1'), c('pre.1968', 'post.1968')))
ICU.birthyear
prop.table(ICU.birthyear, 1)
c.test = chisq.test(ICU.birthyear)
c.test
c.test$expected
```
###This test suggests the age districutions of H1N1 vs. H3N2 ICU admissions are not independent. H3N2 ICU admissions are much more likely to have been born prior to 1968 than H1N1 ICU admissions.




#Admitted days

```{r}
Admitted.days = matrix(c(88, 71, 131, 166, 99, 130, 105, 77, 334, 249, 175, 135, 54, 33, 54, 11), ncol = 2, nrow = 8, byrow = TRUE, dimnames = list(NULL, c('H1N1', 'H3N2')))
Admitted.days = data.frame(Admitted.days, 'n.days' = c('0', '1-3', '4-7', '>7', '0', '1-3', '4-7', '>7'), 'birth.year' = c('pre.1968', 'pre.1968', 'pre.1968', 'pre.1968', 'post.1968', 'post.1968', 'post.1968', 'post.1968'), 'admitted' = c(0, 1, 1, 1, 0, 1, 1, 1), 'wk' = c(0, 0, 0, 1, 0, 0, 0, 1))
Admitted.days
```


Look at the distribution of admissions (any length greater than 0)
```{r}
# Admitted, pre.1968
colSums(subset(Admitted.days, admitted == 1 & birth.year == 'pre.1968')[,1:2])
# Admitted, post.1968
colSums(subset(Admitted.days, admitted == 1 & birth.year == 'post.1968')[,1:2])
Admitted.table = matrix(c(colSums(subset(Admitted.days, admitted == 1 & birth.year == 'pre.1968')[,1:2]), 
         colSums(subset(Admitted.days, admitted == 1 & birth.year == 'post.1968')[,1:2])), 
       nrow = 2, ncol = 2, dimnames = list(c('H1N1', 'H3N2'), c('pre.1968', 'post.1968')))
Admitted.table
# Expect a higher fraction of H3N2 admits in the pre-1968 cohort than H1N1
prop.table(Admitted.table, 1)
c.test = chisq.test(Admitted.table)
c.test
c.test$expected
```

###This test suggests the age districutions of H1N1 vs. H3N2 hospital admissions are not independent. H3N2 hospital admissions are much more likely to have been born prior to 1968 than H1N1 ICU admissions.





Look at the distribution of admissions longer than 1 week
```{r}
# Admitted, pre.1968
colSums(subset(Admitted.days, birth.year == 'pre.1968' & wk == 1)[,1:2])
# Admitted, post.1968
colSums(subset(Admitted.days, birth.year == 'post.1968' & wk == 1)[,1:2])
wk.table = matrix(c(colSums(subset(Admitted.days, birth.year == 'pre.1968' & wk == 1)[,1:2]), 
         colSums(subset(Admitted.days, birth.year == 'post.1968' & wk == 1)[,1:2])), 
       nrow = 2, ncol = 2, dimnames = list(c('H1N1', 'H3N2'), c('pre.1968', 'post.1968')))
wk.table
# Expect a higher fraction of H3N2 admits in the pre-1968 cohort than H1N1
prop.table(wk.table, 1)
c.test = chisq.test(wk.table)
c.test
c.test$expected
```

##This test suggests the age districutions of H1N1 vs. H3N2 hospital admissions lasting greater than one week are not independent. H3N2 hospital admissions lasting greater than one week are much more likely to have been born prior to 1968 than H1N1 ICU admissions.








Load the full data set
```{r}
raw.data = read.csv('AZ_2016_Hospitalization.csv')
raw.data$admitted = as.numeric(raw.data$day_admit != '0: no admit') # Indicator variable for admitted patients
```

Check whether the pattern holds for 1957 hospital admissions
Expect a lower proportion of H1N1 cases than H3N2 to occur in pre-1957 cohorts
```{r}
admit.table = wk.table*0; colnames(admit.table) = c('pre.1957', 'post.1957')
admit.table[1, 1] = nrow(subset(raw.data, admitted == 1 & MORBSPC == 'A/H1N1 (SWINE-ORIGIN)' & BYEAR < 1957))
admit.table[2, 1] = nrow(subset(raw.data, admitted == 1 & MORBSPC == 'A/H3' & BYEAR < 1957))
admit.table[1, 2] = nrow(subset(raw.data, admitted == 1 & MORBSPC == 'A/H1N1 (SWINE-ORIGIN)' & BYEAR >= 1957))
admit.table[2, 2] = nrow(subset(raw.data, admitted == 1 & MORBSPC == 'A/H3' & BYEAR >= 1957))
# Expect a higher fraction of H3N2 admits in the pre-1957 cohort than H1N1
prop.table(admit.table, 1)
c.test = chisq.test(admit.table)
c.test
c.test$expected
```


```{r}
icu.table = wk.table*0; colnames(icu.table) = c('pre.1957', 'post.1957')
icu.table[1, 1] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H1N1 (SWINE-ORIGIN)' & BYEAR < 1957))
icu.table[2, 1] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H3' & BYEAR < 1957))
icu.table[1, 2] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H1N1 (SWINE-ORIGIN)' & BYEAR >= 1957))
icu.table[2, 2] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H3' & BYEAR >= 1957))
# Expect a higher fraction of H3N2 admits in the pre-1957 cohort than H1N1
icu.table
prop.table(icu.table, 1)
c.test = chisq.test(icu.table)
c.test
c.test$expected
icu.table-c.test$expected
```

Repeat for 1968 break
```{r}
icu.table = wk.table*0; colnames(icu.table) = c('pre.1968', 'post.1968')
icu.table[1, 1] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H1N1 (SWINE-ORIGIN)' & BYEAR < 1968))
icu.table[2, 1] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H3' & BYEAR < 1968))
icu.table[1, 2] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H1N1 (SWINE-ORIGIN)' & BYEAR >= 1968))
icu.table[2, 2] = nrow(subset(raw.data, ICU == 1 & MORBSPC == 'A/H3' & BYEAR >= 1968))
# Expect a higher fraction of H3N2 admits in the pre-1957 cohort than H1N1
icu.table
prop.table(icu.table, 1)
c.test = chisq.test(icu.table)
c.test
c.test$expected
icu.table-c.test$expected
```