---
title: "003 hospdays"
author: "Katie Gostic"
date: "11/1/2017"
output: html_document
---

#### Note: hospdays records the number of days hospitalized after study enrollment. In another script, I test tothosp (the total number of hospitalized days). I try to control for hospitalization unrelated to infelunza by excluding patients with underlying conditions from the tothosp analysis

```{r setup, include=FALSE}
setwd('~/Dropbox/R/2017_INSIGHT/')
rm(list = ls())
source('Import_FLU003.R')
set.seed(91)
library(ROCR)
cols = colors()[c(506, 499, 475)]
```
Notes on data formatting from Deborah Wentworth:

* symdur is symptom duration (days) prior to enrollment
* date info is for enrollment date
* fluvac6 and fluvac12 are flu vaccination in last 6 or last 12 months
* anyvac combines values from fluvac6 and fluvac12, whichever was collected for a given patient is reported.
* anyav is use of antivirals at any time
* anydx is any diagnosis in the medical history section
* flutype is subtype: 1=H1N1, 2=H3N2, 3=flu B, 4=PCR negative, 5=Inf A, subtype unknown, and 6=coinfection with multiple strains
* resolved is symptom resolution within 14 days
* country code is the 3 letter code for country of enrollment - think the abbreviations will be obvious




#### Visualize the relationship between age and duration of hospitalization
```{r warning = FALSE, echo = FALSE}
# Select only cases with confirmed H1N1
valid = dat.003[dat.003$H1N1 == 1 & ! is.na(dat.003$H1N1), ]
plot(jitter(valid$age), jitter(valid$hospdays), ylim = c(1, 70), xlim = c(10, 100), xlab = 'age', ylab = 'symdur', col = 'dodgerblue', main = 'H1N1: Duration of hospitalization by age', cex = .7)
cor.test(valid$age, valid$hospdays, method = 'spearman')
```

There is a positive correlation between age and duration of hospitalization.


#### Visualize the relationship between age and prob of H3N2 infection
```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
plot(jitter(valid$age), jitter(valid$hospdays), ylim = c(0, 70), xlim = c(10, 100), xlab = 'age', ylab = 'symdur', col = 'firebrick1', main = 'H3N2: Duration of hospitalization by age', cex = .7)
cor.test(valid$age, valid$hospdays, method = 'spearman')
```

Results show a positive correlation between duration of hosp and age.

#### Visualize the relationship between country and symptom duration
H1N1

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$H1N1), ]
plot(factor(valid$country), jitter(valid$hospdays),  xlab = '', ylab = 'symdur', col = 'lightblue', main = 'H1N1: Duration of hospitalization by country', cex = .7, las = 3)
```

H3N2

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
plot(factor(valid$country), jitter(valid$hospdays),  xlab = '', ylim = c(0, 60), ylab = 'hosp days', col = 'pink3', main = 'H3N2: duration of hospitalization by country', cex = .7, las = 3)
```

# No clear effect of country

#### Visualize the relationship between season and symptom duration

H1N1

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$H1N1), ]
plot(factor(valid$season), jitter(valid$hospdays),  xlab = '', ylab = 'hospital days', col = 'lightblue', main = 'H1N1: duration of hospitalization by season', cex = .7, las = 3)
```

No clear effect of season.



H3N2

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
plot(factor(valid$season), jitter(valid$hospdays),  xlab = '', ylim = c(0, 60), ylab = 'hosp days', col = 'pink3', main = 'H3N2: duraiton of hospitalization by season', cex = .7, las = 3)
```


No clear effect of season
--> Try models that don't include season and country as blocking vars


### H1N1 10-fold CV
We know the relationship between age and probability of infection should be non-linear. Use cross-validation to verify, and to choose the number of degrees of freedom to include in a spline
```{r fig.height=7, cache=TRUE, echo = FALSE}
## Cross-validation template
# set.seed(30)
# library(splines)
# dat.in = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$H1N1), ]
# ##  Perform 10-fold cross-validation
# # 1. Partition the data into 10 folds
# fold.bounds = matrix(  c(0:9*floor(nrow(dat.in)/10)+1, 1:10*floor(nrow(dat.in)/10)+1), nrow = 10, ncol = 2); fold.bounds[10, 2] = nrow(dat.in) # Set indices at which folds start and end
# fold.inds = sample(1:nrow(dat.in), replace = FALSE) # Randomly order the observations in the data
# 
# max.df = 12
# MSE = matrix(NA, 10, max.df, dimnames = list(paste('fold', 1:10, sep = '.'), paste('df', 1:max.df, sep = '')))
# par(mfrow = c(2,2))
# 
# 
# for(ii in 1:10){
#   ## Fit the model to 9 of 10 folds
#   test.dat = dat.in[fold.inds[fold.bounds[ii,1]:fold.bounds[ii,2]], ]
#   training.dat = dat.in[fold.inds[-(fold.bounds[ii,1]:fold.bounds[ii,2])], ]
#   
#   ## Train the model
#   fits = vector('list', max.df); names(fits) = c('linear', paste('ns', 2:max.df, 'df', sep = ''))
#   fits[[1]] = glm(hospdays ~ age, data = training.dat) # Linear fit
#   for(dd in 2:max.df){
#     fits[[dd]] = glm(hospdays ~ ns(age, df = dd), data = training.dat) # fits a nat spline with dd df
#   }
#   
#   
# 
#   
#   ## Test the model on the test data
#   ## Simulate outcomes using predicted probs
#   ## Calculate test error rate
#   for(jj in 1:length(fits)){
#   # Predict probabilities using each fit
#   preds = predict(fits[[jj]], newdata = list(age = test.dat$age))
#   if(ii == 8){ # For one CV itteration
#   plot.preds = predict(fits[[jj]], newdata = list(age = min(test.dat$age):max(test.dat$age)), se.fit = TRUE)
#   ## Visualize results
#   plot(jitter(test.dat$age, factor = 2.5), test.dat$hospdays, xlim = c(0, 100), xlab = 'age', ylab = 'Symptom duration', main = paste('df =', jj), col = 'dodgerblue')
#   lines(min(test.dat$age):max(test.dat$age), plot.preds$fit, col = 'black')
#   }
#   ## Continue cross validation
#   #sim.outcomes = sapply(X = pred.probs, FUN = function(pp) sample(c(0,1), size = 1, prob = c(1-pp, pp)))
#   MSE[ii, jj] = mean((preds - test.dat$hospdays)^2, na.rm = TRUE)
# }
# }
```

Plot the overall test error rate vs. df
```{r echo = FALSE}
# par(mfrow = c(1,1))
# plot(1:max.df, colMeans(MSE), ylab = 'MSE', xlab = 'df', type = 'b', main = 'H1N1 10-fold CV to choose df')
```

No clear preference. Use 4 df?


### H3N2 10-fold CV
We know the relationship between age and probability of infection should be non-linear. Use cross-validation to verify, and to choose the number of degrees of freedom to include in a spline
```{r fig.height=7, cache=TRUE, echo = FALSE}
# library(splines)
# set.seed(23)
# dat.in = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
# ##  Perform 10-fold cross-validation
# # 1. Partition the data into 10 folds
# fold.bounds = matrix(  c(0:9*floor(nrow(dat.in)/10)+1, 1:10*floor(nrow(dat.in)/10)+1), nrow = 10, ncol = 2); fold.bounds[10, 2] = nrow(dat.in) # Set indices at which folds start and end
# fold.inds = sample(1:nrow(dat.in), replace = FALSE) # Randomly order the observations in the data
# 
# max.df = 12
# MSE = matrix(NA, 10, max.df, dimnames = list(paste('fold', 1:10, sep = '.'), paste('df', 1:max.df, sep = '')))
# par(mfrow = c(2,2))
# 
# 
# for(ii in 1:10){
#   ## Fit the model to 9 of 10 folds
#   test.dat = dat.in[fold.inds[fold.bounds[ii,1]:fold.bounds[ii,2]], ]
#   training.dat = dat.in[fold.inds[-(fold.bounds[ii,1]:fold.bounds[ii,2])], ]
#   
#   ## Train the model
#   fits = vector('list', max.df); names(fits) = c('linear', paste('ns', 2:max.df, 'df', sep = ''))
#   fits[[1]] = glm(hospdays ~ age, data = training.dat) # Linear fit
#   for(dd in 2:max.df){
#     fits[[dd]] = glm(hospdays ~ ns(age, df = dd), data = training.dat) # fits a nat spline with dd df
#   }
#   
#   
# 
#   
#   ## Test the model on the test data
#   ## Simulate outcomes using predicted probs
#   ## Calculate test error rate
#   for(jj in 1:length(fits)){
#   # Predict probabilities using each fit
#   preds = predict(fits[[jj]], newdata = list(age = test.dat$age))
#   if(ii == 8){ # For one CV itteration
#   plot.preds = predict(fits[[jj]], newdata = list(age = min(test.dat$age):max(test.dat$age)), se.fit = TRUE)
#   ## Visualize results
#   plot(jitter(test.dat$age, factor = 2.5), test.dat$hospdays, xlim = c(0, 100), xlab = 'age', ylab = 'Symptom duration', main = paste('df =', jj), col = 'dodgerblue')
#   lines(min(test.dat$age):max(test.dat$age), plot.preds$fit, col = 'black')
#   }
#   ## Continue cross validation
#   #sim.outcomes = sapply(X = pred.probs, FUN = function(pp) sample(c(0,1), size = 1, prob = c(1-pp, pp)))
#   MSE[ii, jj] = mean((preds - test.dat$hospdays)^2, na.rm = TRUE)
# }
# }
```


Plot the overall test error rate vs. df
```{r echo = FALSE}
# par(mfrow = c(1,1))
# plot(1:max.df, colMeans(MSE), ylab = 'MSE', xlab = 'df', type = 'b', main = 'H3N2 10-fold CV to choose df')
```

Conclusion: Clear preference for linear fit for H3N2

## Set up a logistic regression that includes the following predictors:
* age
* imprinting status
* vaccination status
* antiviral use
* season
* country





### Clean data for fitting
```{r echo = FALSE}
H1N1.model.dat = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$H1N1) & !is.na(dat.003$hospdays) & !is.na(dat.003$anyvac), ]
# Check that all relevant variables are not NA
which(is.na(H1N1.model.dat$hospdays))
which(is.na(H1N1.model.dat$country))
which(is.na(H1N1.model.dat$season))
which(is.na(H1N1.model.dat$anyvac))
which(is.na(H1N1.model.dat$anyav))
which(is.na(H1N1.model.dat$anydx))
which(is.na(H1N1.model.dat$age))

# Group countries with 20 or fewer valid cases into "other"
table(H1N1.model.dat$country)
H1N1.model.dat$country[which(H1N1.model.dat$country %in% c('Austria', 'Belgium ', 'Chile', 'China', 'Norway', 'Peru', 'Poland', 'Singapore'))] = 'Other'

# Convert blocking variables to factors
H1N1.model.dat$anyav = factor(H1N1.model.dat$anyav)
H1N1.model.dat$anyvac = factor(H1N1.model.dat$anyvac)
H1N1.model.dat$anydx = factor(H1N1.model.dat$anydx)
H1N1.model.dat$country = factor(H1N1.model.dat$country)
H1N1.model.dat$season = factor(H1N1.model.dat$season)

# Split into training and test data
nrow(H1N1.model.dat)
test.inds = sample(1:nrow(H1N1.model.dat), size = 72, replace = FALSE)
train.H1N1 = H1N1.model.dat[-test.inds, ]
test.H1N1 = H1N1.model.dat[test.inds, ]
```


### First fit a model where the only independent variable is age
Treat vaccination, antivial use, underlying symptoms, country and season as blocking variables with fixed effects
```{r}
library(splines)
## H1N1 fit to medical history only (no effect of country, season, age or imprinting)
fit00 = glm(hospdays ~ anyvac + anyav + anydx, data = train.H1N1)
summary(fit00)

## H1N1 fit to country, season and medical history only (no effect of age or imprinting)  
fit0 = glm(hospdays ~ anyvac + anyav + anydx + country + season, data = train.H1N1)
summary(fit0)

## H1N1 fit to age only, plus fixed effects of vaccination, av use, underlying conditions, country and season
fit1 = glm(hospdays ~ ns(age, knots = 65) + anyvac + anyav + anydx + country + season, data = train.H1N1)
summary(fit1)

## H1N1 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, country and season
fit2 = glm(hospdays ~ ns(age, knots = 65) + p.g1.protection + anyvac + anyav + anydx + country + season, data = train.H1N1)
summary(fit2)

## H1N1 fit to age only, plus fixed effects of vaccination, av use, underlying conditions NO COUNTRY AND SEASON
fit3 = glm(hospdays ~ ns(age, knots = 65) + anyvac + anyav + anydx, data = train.H1N1)
summary(fit3)

## H1N1 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, NO COUNTRY AND SEASON
fit4 = glm(hospdays ~ ns(age, knots = 65) + p.g1.protection + anyvac + anyav + anydx, data = train.H1N1)
summary(fit4)


## Plot the fits for each model side by side
par(mfrow = c(1, 2), las = 3, mar = c(6, 6, 6, 3), cex.axis = .7)
library(gam)
plot.gam(fit00, se = T, col = 'dodgerblue', main = 'Simplified Baseline')
plot.gam(fit0, se = T, col = 'dodgerblue', main = 'Baseline')
plot.gam(fit1, se = T, col = 'dodgerblue', main = 'Baseline + age + imp')
plot.gam(fit2, se = T, col = 'dodgerblue', main = 'Baseline + age + imp')
plot.gam(fit3, se = T, col = 'dodgerblue', main = 'Simple baseline + age + imp')
plot.gam(fit4, se = T, col = 'dodgerblue', main = 'Simple baseline + age + imp')

pdf('003Hospdays_H1N1.pdf')
plot.gam(fit4, se = T, col = 'dodgerblue', main = 'Simple baseline + age + imp')
dev.off()

# Predict probs for each patient
pred00 = predict(fit00, newdata = (test.H1N1))
pred0 = predict(fit0, newdata = (test.H1N1))
pred1 = predict(fit1, newdata = (test.H1N1))
pred2 = predict(fit2, newdata = (test.H1N1))
pred3 = predict(fit3, newdata = (test.H1N1))
pred4 = predict(fit4, newdata = (test.H1N1))
  
# Estimate the simulated error rate
MSE = numeric(6); names(MSE) = c('simple.baseline', 'baseline', 'baeline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')
MSE[1] = mean((pred00 - test.H1N1$hospdays)^2)
MSE[2] = mean((pred0 - test.H1N1$hospdays)^2)
MSE[3] = mean((pred1 - test.H1N1$hospdays)^2)
MSE[4] = mean((pred2 - test.H1N1$hospdays)^2)
MSE[5] = mean((pred3 - test.H1N1$hospdays)^2)
MSE[6] = mean((pred4 - test.H1N1$hospdays)^2)
sort(MSE)

AIC = c(fit00$aic, fit0$aic, fit1$aic, fit2$aic, fit3$aic, fit4$aic); names(AIC) =  c('simple.baseline', 'baseline', 'baeline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')
del.AIC = sort(AIC - min(AIC))
del.AIC

load('master.AIC.table.H1N1.RData')
master.AIC.table['003Hospdays',  c('simple.baseline', 'baseline', 'baseline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')] = AIC - min(AIC)
save(master.AIC.table, file = 'master.AIC.table.H1N1.RData')
rm(master.AIC.table)
```




### Clean H3N2 data for fitting
```{r echo = FALSE}
H3N2.model.dat = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2) & !is.na(dat.003$hospdays) & !is.na(dat.003$anyvac), ]
# Check that all relevant variables are not NA
which(is.na(H3N2.model.dat$hospdays))
which(is.na(H3N2.model.dat$country))
which(is.na(H3N2.model.dat$season))
which(is.na(H3N2.model.dat$anyvac))
which(is.na(H3N2.model.dat$anyav))
which(is.na(H3N2.model.dat$anydx))
which(is.na(H3N2.model.dat$age))

# Group countries with 20 or fewer valid cases into "other"
table(H3N2.model.dat$country)
H3N2.model.dat$country[which(H3N2.model.dat$country %in% c('Belgium ', 'China', 'Germany', 'Peru'))] = 'Other'

# Convert blocking variables to factors
H3N2.model.dat$anyav = factor(H3N2.model.dat$anyav)
H3N2.model.dat$anyvac = factor(H3N2.model.dat$anyvac)
H3N2.model.dat$anydx = factor(H3N2.model.dat$anydx)
H3N2.model.dat$country = factor(H3N2.model.dat$country)
H3N2.model.dat$season = factor(H3N2.model.dat$season)

# Split into training and test data
nrow(H3N2.model.dat)
test.inds = sample(1:nrow(H3N2.model.dat), size = 73, replace = FALSE)
train.H3N2 = H3N2.model.dat[-test.inds, ]
test.H3N2 = H3N2.model.dat[test.inds, ]
```


```{r}
library(splines)
## H3N2 fit to medical history only (no effect of country, season, age or imprinting)
fit00 = glm(hospdays ~ anyvac + anyav + anydx, data = train.H3N2)
summary(fit00)

## H3N2 fit to country, season and medical history only (no effect of age or imprinting)  
fit0 = glm(hospdays ~ anyvac + anyav + anydx + country + season, data = train.H3N2)
summary(fit0)

## H3N2 fit to age only, plus fixed effects of vaccination, av use, underlying conditions, country and season
fit1 = glm(hospdays ~ ns(age, knots = 65) + anyvac + anyav + anydx + country + season, data = train.H3N2)
summary(fit1)

## H3N2 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, country and season
fit2 = glm(hospdays ~ ns(age, knots = 65) + p.g2.protection + anyvac + anyav + anydx + country + season, data = train.H3N2)
summary(fit2)

## H3N2 fit to age only, plus fixed effects of vaccination, av use, underlying conditions NO COUNTRY AND SEASON
fit3 = glm(hospdays ~ ns(age, knots = 65) + anyvac + anyav + anydx, data = train.H3N2)
summary(fit3)

## H3N2 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, NO COUNTRY AND SEASON
fit4 = glm(hospdays ~ ns(age, knots = 65) + p.g2.protection + anyvac + anyav + anydx, data = train.H3N2)
summary(fit4)


## Plot the fits for each model side by side
par(mfrow = c(1, 2), las = 3, mar = c(6, 6, 6, 3), cex.axis = .7)
library(gam)
plot.gam(fit00, se = T, col = 'firebrick1', main = 'Simplified Baseline')
plot.gam(fit0, se = T, col = 'firebrick1', main = 'Baseline')
plot.gam(fit1, se = T, col = 'firebrick1', main = 'Baseline + age + imp')
plot.gam(fit2, se = T, col = 'firebrick1', main = 'Baseline + age + imp')
plot.gam(fit3, se = T, col = 'firebrick1', main = 'Simple baseline + age + imp')
plot.gam(fit4, se = T, col = 'firebrick1', main = 'Simple baseline + age + imp')

pdf('003Hospdays_H3N2.pdf')
plot.gam(fit4, se = T, col = 'firebrick1', main = 'Simple baseline + age + imp')
dev.off()

# Predict probs for each patient
pred00 = predict(fit00, newdata = test.H3N2)
pred0 = predict(fit0, newdata = test.H3N2)
pred1 = predict(fit1, newdata = test.H3N2)
pred2 = predict(fit2, newdata = test.H3N2)
pred3 = predict(fit3, newdata = test.H3N2)
pred4 = predict(fit4, newdata = test.H3N2)
  
# Estimate the simulated error rate
MSE = numeric(6); names(MSE) = c('simple.baseline', 'baseline', 'baeline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')
MSE[1] = mean((pred00 - test.H3N2$hospdays)^2)
MSE[2] = mean((pred0 - test.H3N2$hospdays)^2)
MSE[3] = mean((pred1 - test.H3N2$hospdays)^2)
MSE[4] = mean((pred2 - test.H3N2$hospdays)^2)
MSE[5] = mean((pred3 - test.H3N2$hospdays)^2)
MSE[6] = mean((pred4 - test.H3N2$hospdays)^2)
sort(MSE)

AIC = c(fit00$aic, fit0$aic, fit1$aic, fit2$aic, fit3$aic, fit4$aic); names(AIC) =  c('simple.baseline', 'baseline', 'baseline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')
del.AIC = sort(AIC - min(AIC))
del.AIC

load('master.AIC.table.H3N2.RData')
master.AIC.table['003Hospdays',  c('simple.baseline', 'baseline', 'baseline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')] = AIC - min(AIC)
save(master.AIC.table, file = 'master.AIC.table.H3N2.RData')
rm(master.AIC.table)
```

