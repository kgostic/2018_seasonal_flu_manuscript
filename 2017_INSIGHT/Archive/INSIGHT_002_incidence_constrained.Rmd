---
title: "002 incidence"
author: "Katie Gostic"
date: "11/1/2017"
output: html_document
---

```{r setup, include=FALSE}
setwd('~/Dropbox/R/2017_INSIGHT/')
rm(list = ls())
source('Import_FLU002.R')
set.seed(43)
cols = c("#4477AA", "#DDCC77", "#CC6677")
cols = colors()[c(393, 464, 29)]
cols = colors()[c(506, 499, 475)]
# Pull out variables used in model
full.dat = dat.002
dat.002 = subset(dat.002, select = c('age', 'infected', 'anyvac', 'anydx', 'anyav', 'season', 'country', 'challenge', 'protected_grp', 'protected_sub', 'protected_N'))
which(apply(dat.002, MARGIN = 1,  function(xx) (any(is.na(xx)))))
# Exclude rows with any NAs
dat.002 = na.omit(dat.002)
# Exclude those with unknown vaccination status.
invalid = which(dat.002$anyvac == 2)
dat.002 = dat.002[-invalid, ]
```
Notes on data formatting from Deborah Wentworth:

* symdur is symptom duration (days) prior to enrollment
* date info is for enrollment date
* fluvac6 and fluvac12 are flu vaccination in last 6 or last 12 months
* anyvac combines values from fluvac6 and fluvac12, whichever was collected for a given patient is reported.
* anyav is use of antivirals at any time
* anydx is any diagnosis in the medical history section
* flutype is subtype: 1=H1N1, 2=H3N2, 3=flu B, 4=PCR negative, 5=Inf A, subtype unknown, and 6=coinfection with multiple strains
* resolved is symptom resolution within 14 days
* country code is the 3 letter code for country of enrollment - think the abbreviations will be obvious

### Clean data for fitting
```{r echo = FALSE}
# Group countries with 30 or fewer valid cases into "other"
table(dat.002$country)
dat.002$country[which(dat.002$country %in% c('Austria', 'Portugal'))] = 'Other'

# Convert blocking variables to factors
dat.002$anyav = factor(dat.002$anyav)
dat.002$anyvac = factor(dat.002$anyvac)
dat.002$anydx = factor(dat.002$anydx)
dat.002$country = factor(dat.002$country)
dat.002$season = factor(dat.002$season)
dat.002$challenge = factor(dat.002$challenge)

# Split into training and test data
nrow(dat.002)
test.inds = sample(1:nrow(dat.002), size = 1000, replace = FALSE)
train = dat.002[-test.inds, ]
test = dat.002[test.inds, ]
```



## Test for heterogeneity and outliers in different variables
```{r}
par(mfrow = c(1,1))
# Age
boxplot(age ~ infected, data = dat.002, xlab = "Infected?", ylab = 'age', main = 'age vs. infection status', varwidth = TRUE)
# Vaccination status
table(dat.002$anyvac, dat.002$infected)
# Antiviral status
table(dat.002$anyav, dat.002$infected)
# Underlying symptoms
table(dat.002$anydx, dat.002$infected)
# Season
tt = t(table(dat.002$infected, dat.002$season))
normalized = t(tt/rowSums(tt))
barplot(normalized, data = dat.002, xlab = "Infected?", ylab = 'season', main = 'season vs. infection status')
# Country
tt = t(table(dat.002$infected, dat.002$country))
normalized = t(tt/rowSums(tt))
barplot(normalized, data = dat.002, xlab = "Infected?", ylab = 'country', main = 'country vs. infection status')
```

* age
* imprinting status
* vaccination status
* antiviral use
* underlying symptoms
* season
* country












### First fit a model where the only independent variable is age
Treat vaccination, antivial use, underlying symptoms, country and season as blocking variables with fixed effects
```{r}
# library(splines)
# library(ROCR)
# 
# ## Fit to country, season and medical history only (no effect of age or imprinting)
fit0 = glm(infected ~ anyav + anydx + country + season + challenge*anyvac, data = train, family = binomial)
summary(fit0)
# 
# ## H1N1 fit to age only, plus fixed effects of vaccination, av use, underlying conditions, country and season
# fit1 = glm(infected ~ ns(age, knots = 65)+anyav + anydx + country + season + challenge*anyvac, data = train, family = binomial)
# summary(fit1)
# 
# 
# ## H1N1 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, country and season
# fit2 = glm(infected ~ ns(age, knots = 65)+protected_grp + anyav + anydx + country + season + challenge*anyvac , data = train, family = binomial)
# summary(fit2)
# 
# # Add imprinting at H.subtype level
# fit3 = glm(infected ~ ns(age, knots = 65)+protected_sub + anyav + anydx + country + season + challenge*anyvac , data = train, family = binomial)
# summary(fit3)
# 
# # Add imprinting at N.subtype level
# fit4 = glm(infected ~ protected_N + anyav + anydx + country + season + challenge*anyvac + ns(age, knots = 65), data = train, family = binomial)
# summary(fit4)
library(glmmML)
ID = factor(paste(dat.002$country, dat.002$season, sep = ''))
fit0 = glmmML(infected ~ age*challenge + protected_grp + anyvac*challenge + anydx + anyav, cluster =ID, data = dat.002, family = 'binomial')
summary(fit0)

fit1 = glmmML(infected ~ age + protected_grp + anyvac*challenge + anydx + anyav, cluster =ID, data = dat.002, family = 'binomial')
summary(fit1)

```

## Now validate the models
# Residuals vs. age:
```{r}
## Write a function that takes in the total n observations in a category and divides into groups of 10
group.fun = function(N = 10462, grp.size = 10, min.ID = 0){
  n.grps = ceiling(N/grp.size)
  IDs = rep((1:n.grps)+min.ID, each = grp.size); IDs = IDs[1:N]
  IDs
}

IDs = group.fun()

par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$age)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized age name', main = 'Mean residual\ngroups of 10\nsorted by age')
abline(h = 0, col = 'red')
```

# Residuals vs. country:
```{r}
## Model 0:
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$country)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized country name', main = 'Mean residual\ngroups of 10\nsorted by country')
abline(h = 0, col = 'red')
```


# Residuals vs. anydx:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$anydx)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized anydx name', main = 'Mean residual\ngroups of 10\nsorted by anydx')
abline(h = 0, col = 'red')
```


# Residuals vs. anyvac:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$anyvac)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized anyvac name', main = 'Mean residual\ngroups of 10\nsorted by anyvac')
abline(h = 0, col = 'red')
```

# Residuals vs. anyav:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$anyav)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized anyav name', main = 'Mean residual\ngroups of 10\nsorted by anyav')
abline(h = 0, col = 'red')
```

# Residuals vs. challenge:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$challenge)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized challenge name', main = 'Mean residual\ngroups of 10\nsorted by challenge')
abline(h = 0, col = 'red')
```

# Residuals vs. protected_grp:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit2)
r0 = r0[order(dat.002$protected_grp)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized protected_grp name', main = 'Mean residual\ngroups of 10\nsorted by protected_grp')
abline(h = 0, col = 'red')
```

# Residuals vs. protected_sub:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit3)
r0 = r0[order(dat.002$protected_sub)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized protected_sub name', main = 'Mean residual\ngroups of 10\nsorted by protected_sub')
abline(h = 0, col = 'red')
```

# Residuals vs. protected_N:
```{r}
par(mfrow=c(1,1), mar = c(5,2,5,2))
r0 = resid(fit4)
r0 = r0[order(dat.002$protected_N)]
means = sapply(1:max(IDs), FUN = function(xx) mean(r0[IDs==xx]))
plot(1:max(IDs), means, ylab = 'mean residual', xlab = 'Ordered by alphabetized protected_N name', main = 'Mean residual\ngroups of 10\nsorted by protected_N')
abline(h = 0, col = 'red')
```





```{r}
## Plot the fits for each model side by side
par(mfrow = c(1, 2), las = 3, mar = c(6, 6, 6, 3), cex.axis = .7)
library(gam)
plot.gam(fit0, se = T, col = 'darkslateblue', main = 'Baseline')
plot.gam(fit1, se = T, col = 'darkslateblue', main = 'Baseline + age')
plot.gam(fit2, se = T, col = 'darkslateblue', main = 'Baseline + age + H.group.imp')
plot.gam(fit3, se = T, col = 'darkslateblue', main = 'Baseline + age + H.subtype.imp')
plot.gam(fit4, se = T, col = 'darkslateblue', main = 'Baseline + age + N.subtype.imp')
pdf('002Incidence_constrained.pdf')
plot.gam(fit2, se = T, col = 'darkslateblue', main = 'Baseline + age + imp')
dev.off()


## Test performance on test data
# Predict probs for each patient
probs0 = predict(fit0, newdata = test, type = 'response')
probs1 = predict(fit1, newdata = test, type = 'response')
probs2 = predict(fit2, newdata = test, type = 'response')
probs3 = predict(fit3, newdata = test, type = 'response')
probs4 = predict(fit4, newdata = test, type = 'response')

# Create a predict object
pr0 = prediction(probs0, test$infected)
pr1 = prediction(probs1, test$infected)
pr2 = prediction(probs2, test$infected)
pr3 = prediction(probs3, test$infected)
pr4 = prediction(probs4, test$infected)

# Assess tp and fp
prf0 = performance(pr0, measure = 'tpr', x.measure = 'fpr')
prf1 = performance(pr1, measure = 'tpr', x.measure = 'fpr')
prf2 = performance(pr2, measure = 'tpr', x.measure = 'fpr')
prf3 = performance(pr3, measure = 'tpr', x.measure = 'fpr')
prf4 = performance(pr4, measure = 'tpr', x.measure = 'fpr')

# Calculate AUCs
auc = sapply(list(pr0, pr1, pr2, pr3, pr4), FUN = function(xx){aa = performance(xx, measure = 'auc')
                                                                      round(aa@y.values[[1]], 3) })

# Plot AUC
par(mfrow = c(1,1))
plot(prf0, lwd = 2, col = cols[3])
plot(prf1, col = cols[2], add = TRUE, lwd = 2)
plot(prf2, col = cols[1], add = TRUE, lwd = 2)
plot(prf3, col = 'limegreen', add = TRUE, lwd = 2)
plot(prf4, col = 'magenta', add = TRUE, lwd = 2)
abline(a = 0, b = 1, lty = 2)
legend('bottomright', paste(c('baseline                  AUC = ', 'baseline+age          AUC = ', 'baseline+age+imp  AUC = ', 'baseline+age+sub  AUC =', 'baseline+age+N     AUC = '), auc), col = c(cols[3:1], 'limegreen', 'magenta'),  lty = 1)

pdf('002Incidence_AUC_constrained.pdf')
par(lwd = 3.5, cex = 1.5, cex.axis = 1.5, cex.lab = 1.5)
# Plot AUC
par(mfrow = c(1,1))
plot(prf0, lwd = 2, col = cols[3])
plot(prf1, col = cols[2], add = TRUE, lwd = 2)
plot(prf2, col = cols[1], add = TRUE, lwd = 2)
plot(prf3, col = 'limegreen', add = TRUE, lwd = 2)
plot(prf4, col = 'magenta', add = TRUE, lwd = 2)
abline(a = 0, b = 1, lty = 2)
legend('bottomright', paste(c('baseline                  AUC = ', 'baseline+age          AUC = ', 'baseline+age+imp  AUC = ', 'baseline+age+sub  AUC =', 'baseline+age+N     AUC = '), auc), col = c(cols[3:1], 'limegreen', 'magenta'),  lty = 1)
dev.off()


# Calculate AUC for test data
AIC = c(fit0$aic, fit1$aic, fit2$aic, fit3$aic, fit4$aic); names(AIC) =  c('baseline', 'baseline+age', 'baseline+age+imp', 'baseline+age+sub', 'baseline+age+N')
del.AIC = sort(AIC - min(AIC))
del.AIC

load('master.AIC.table.constrained.RData')
master.AIC.table['002Incidence', c('baseline', 'baseline+age', 'baseline+age+imp', 'baseline+age+sub', 'baseline+age+N')] = AIC - min(AIC)
save(master.AIC.table, file = 'master.AIC.table.constrained.RData')
rm(master.AIC.table)
```


