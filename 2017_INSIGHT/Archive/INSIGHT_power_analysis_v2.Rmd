---
title: "INSIGHT_power_analysis"
author: "Katie Gostic"
date: "10/2/2017"
output: html_document
---

# Power analysis of INSIGHT data
Verify that the data is sufficiently powered for all proposed aims.

# Logistic regression analyses
Use a logistic regression model to predict the probability of severity outcome measures from FLU002 (hospitalization, symptoms > 14 days),  as a funciton of age and imprinting status.

Note: In the full analysis we will consider other factors such as vaccination status and antiviral use, which may also influence the probability of hospitalization, or of symptoms > 14 days. But since these preliminary data do not include informaiton on case history, we omit these factors from the power analysis.

#### Basic strategy:
* Simulate data that assumes an individual's probabilitiy of hospitalization, or of symptoms lasting >= 14 days depends on age and imprinting status.
* Draw a number of simulated data points from each age group that matches the number of observations in the FLU002 data.
* Fit a logistic regression model to the simulated data and test whether the model is able to detect a significant relationship between imprinting and probability of hospitalization, given the available sample size and age distribution.
+ Test three differnt imprinting effect sizes.


##### Estimated probability that each age group LACKS imprinting protection against the challenge strain
In other words, what fraction of each age group imprinted to the opposite group in childhood? Individuals lacking protective childhood imrpinting are predicted to be at relatively high risk of severe disease and hospitalization.

These estimates are based on a median year of case detection in 2013. Reconstructions of childhood imrpinting patterns follow methods developed in Gostic et al., 2016. Using the full data, I will be able to calculate these probabilities individually, for each patient, based on birth year, which will provide more power than in these preliminary analyses.

```{r, echo = FALSE, fig.height=3.5, cache=TRUE}
## Import imprinting reconstructions for USA
load('../2017_seasonal_flu/Seasonal_group_weights.RData')
# Keep only 2013 reconstructions
wm.H1 = wm.H1['2013', ]
wm.H3 = wm.H3['2013', ]
wo.H1 = wo.H1['2013', ]
wo.H3 = wo.H3['2013', ]
# Write a function to bin age groups
bin.age.gropus = function(imp.vec){
  bin.starts = c(18, 30, 40, 50, 60 ,70)
  bin.ends   = c(29, 39, 49, 59, 69, 99)
  binned.averages = numeric(6)
  for(ii in 1:6){
    binned.averages[ii] = mean(imp.vec[as.character(bin.starts[ii]:bin.ends[ii])])
  }
  binned.averages
}
# Bin age groups
wm.H1.binned = bin.age.gropus(wm.H1)
wm.H3.binned = bin.age.gropus(wm.H3)
wo.H1.binned = bin.age.gropus(wo.H1)
wo.H3.binned = bin.age.gropus(wo.H3)
# Plot in the same style as above
plot(18:99, rep(wo.H1.binned, times = c(12, 10, 10, 10, 10, 30)), ylim = c(0, 1), xlab = 'Age', ylab = 'P(Unprotected by imprinting)', pch = 16, col = 'dodgerblue', main = 'Estimated fraction lacking H1N1 imprinting protection')
#points(c(15, 35, 45, 55, 65, 80), c(2.9, 4.0, 2.4, 5.4, 8.2, 14.8))

plot(18:99, rep(wo.H3.binned, times = c(12, 10, 10, 10, 10, 30)), ylim = c(0, 1), xlab = 'Age', ylab = 'P(Unprotected by imprinting)', pch = 16, col = 'firebrick2', main = 'Estimated fraction lacking H3N2 imprinting protection')
#points(c(15, 35, 45, 55, 65, 80), c(.04, 1, 0, .7, 1.1, 4.4))
```
# 1. Power analysis for effect of imprinting on probability of hospitalization
Assumptions:

* Assume the baseline probability of hospitalization is 0.033 for H1N1 and about0.003 for H3N2. These values are slightly lower than the overall percentage of hospitalized cases in summary data.
* Assume probability of hospitalization is roughly four times as high for adults in the 70+ age group, as for younger adults. This is consistent with patterns in the preliminary data:
+ H1N1: 3.72% of adults under age 70 hosptialized, vs 14.8% of adults over age 70 hospitalized
+ H3N2: 0.58% of adults under age 70 hospitalized, vs. 4.4% of adults over age 70 hospitalized
* Assume individuals who lack imprinting protection are 1.25 times as likely (small effect size), 1.6 times as likely (moderate effect size), or 2 times as likely (large effect size) to become hospitalized, in comparison to individuals protected by childhood imprinting.


## Simulate 1000 datasets, fit a logistic model to each, and then assess what fraction of times the imprinitng coefficient is significant

* Simulate data using the same number of cases in each age group as in the observed data.
* The fraction of itmes the imprinting coefficient is significant at p = 0.05 is equivalent to power.

#### Analysis using H1N1 parameters and sample sizes
```{r, echo = FALSE, cache=TRUE}
# Set assumed baselin probabilities
baseline.H1 = .033
baseline.H3 = .003
# How many simulations?
n.sims = 1000

# Expand vector of imprinting probabilities so that each entry represents a single age
wo.H1.expanded = rep(wo.H1.binned, times = c(12, 10, 10, 10, 10, 30)); names(wo.H1.expanded) = 18:99 

# Initialize matrix of results
H1.pvals = matrix(NA, n.sims, 3, dimnames = list(NULL, c('small', 'med', 'large')))


## H1N1 simulation
for(ss in 1:n.sims){
no.pts.H1 = c(627, 526, 372, 260, 98, 27) # How many patients in each age group?
bin.starts = c(18, 30, 40, 50, 60 ,70) # Define beginning and end of age bins
bin.ends   = c(29, 39, 49, 59, 69, 99)
# Draw patient ages, using the numbers of observations in each bin
simulated.ages = unlist(sapply(1:6, function(xx) sample(x = bin.starts[xx]:bin.ends[xx], size = no.pts.H1[xx], replace = TRUE)))

# Get the probability that each simulated patient lacks imprinting, based on their age
prob.lacks.imprinting = wo.H1.expanded[as.character(simulated.ages)]
# Using the above probabilities, perform a Bernoulli trial. 0 indicates no imprinting, 1 indicates imprinting
simulated.imprinting.status = sapply(prob.lacks.imprinting, function(pp) rbinom(n = 1, size = 1, prob = 1-pp))

# Set imprinting-specific modifiers
imp.small = imp.med = imp.large = rep(1, length(simulated.ages))
# For small effect size, prob of hospitalization is 1.25 as high in individuals lacking imprinting protection
imp.small[which(simulated.imprinting.status == 0)] = 1.25 
# For med effect size, prob of hospitalization is 1.6 as high in individuals lacking imprinting protection
imp.med[which(simulated.imprinting.status == 0)] = 1.6 
# For large effect size, prob of hospitalization is 2 times as high in individuals lacking imprinting protection
imp.large[which(simulated.imprinting.status == 0)] = 2

# Set age-specific modifier (prob of hospitalization is 4 times greater for those over age 70)
age.mod = rep(1, length(simulated.ages))
age.mod[which(simulated.ages >= 70)] = 4

# Calculate probabilities of hospitalization based on age and imprinting status
p.hosp = cbind(baseline.H1*imp.small*age.mod, baseline.H1*imp.med*age.mod, baseline.H1*imp.large*age.mod); colnames(p.hosp) = c('small', 'med', 'large')

# Perform a Bernoulli trial for each simulated patient to determine if they are hospitalized or not
sim.hosp.status = p.hosp*0 # Initialize
for(ii in 1:length(p.hosp)){
  sim.hosp.status[ii] = rbinom(1, 1, p.hosp[ii])
}

# Fit a logistic model to simulated data
small.fit = glm(sim.hosp.status[,1] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
med.fit = glm(sim.hosp.status[,2] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
large.fit = glm(sim.hosp.status[,3] ~ simulated.ages + prob.lacks.imprinting, family = binomial)

H1.pvals[ss, 1] = summary(small.fit)$coefficients[3, 4]
H1.pvals[ss, 2] = summary(med.fit)$coefficients[3, 4]
H1.pvals[ss, 3] = summary(large.fit)$coefficients[3, 4]
}
```

Power: what % of runs gave a significant result for small, med and large effect sizes?
```{r, echo = FALSE}
apply(H1.pvals, 2, function(xx) sum(xx <= 0.05))/n.sims
```


#### Analysis using H3N2 parameters and sample sizes
```{r, echo = FALSE, cache = TRUE}
no.pts.H3 = c(496, 521, 422, 307, 178, 90) # How many patients in each age group?
bin.starts = c(18, 30, 40, 50, 60 ,70) # Define beginning and end of age bins
bin.ends   = c(29, 39, 49, 59, 69, 99)

# Expand vector of imprinting probabilities so that each entry represents a single age
wo.H3.expanded = rep(wo.H3.binned, times = c(12, 10, 10, 10, 10, 30)); names(wo.H3.expanded) = 18:99 

# Initialize matrix of results
H3.pvals = matrix(NA, n.sims, 3, dimnames = list(NULL, c('small', 'med', 'large')))


## H3N1 simulation
for(ss in 1:n.sims){
# Draw patient ages, using the numbers of observations in each bin
simulated.ages = unlist(sapply(1:6, function(xx) sample(x = bin.starts[xx]:bin.ends[xx], size = no.pts.H3[xx], replace = TRUE)))

# Get the probability that each simulated patient lacks imprinting, based on their age
prob.lacks.imprinting = wo.H3.expanded[as.character(simulated.ages)]
# Using the above probabilities, perform a Bernoulli trial. 0 indicates no imprinting, 1 indicates imprinting
simulated.imprinting.status = sapply(prob.lacks.imprinting, function(pp) rbinom(n = 1, size = 1, prob = 1-pp))

# Set imprinting-specific modifiers
imp.small = imp.med = imp.large = rep(1, length(simulated.ages))
# For small effect size, prob of hospitalization is 1.25 as high in individuals lacking imprinting protection
imp.small[which(simulated.imprinting.status == 0)] = 1.25 
# For med effect size, prob of hospitalization is 1.6 as high in individuals lacking imprinting protection
imp.med[which(simulated.imprinting.status == 0)] = 1.6 
# For large effect size, prob of hospitalization is 2 times as high in individuals lacking imprinting protection
imp.large[which(simulated.imprinting.status == 0)] = 2

# Set age-specific modifier (prob of hospitalization is 4 times greater for those over age 70)
age.mod = rep(1, length(simulated.ages))
age.mod[which(simulated.ages >= 70)] = 4

# Calculate probabilities of hospitalization based on age and imprinting status
p.hosp = cbind(baseline.H3*imp.small*age.mod, baseline.H3*imp.med*age.mod, baseline.H3*imp.large*age.mod); colnames(p.hosp) = c('small', 'med', 'large')

# Perform a Bernoulli trial for each simulated patient to determine if they are hospitalized or not
sim.hosp.status = p.hosp*0 # Initialize
for(ii in 1:length(p.hosp)){
  sim.hosp.status[ii] = rbinom(1, 1, p.hosp[ii])
}

# Fit a logistic model to simulated data
small.fit = glm(sim.hosp.status[,1] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
med.fit = glm(sim.hosp.status[,2] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
large.fit = glm(sim.hosp.status[,3] ~ simulated.ages + prob.lacks.imprinting, family = binomial)

H3.pvals[ss, 1] = summary(small.fit)$coefficients[3, 4]
H3.pvals[ss, 2] = summary(med.fit)$coefficients[3, 4]
H3.pvals[ss, 3] = summary(large.fit)$coefficients[3, 4]
}
```

Power: what % of runs gave a significant result for small, med and large effect sizes?
```{r, echo = FALSE}
apply(H3.pvals, 2, function(xx) sum(xx <= 0.05))/n.sims
```

#### Conclusion: 
These results that we have well below 80% power to detect imprinting effects on the probability of hospitalization, given the available sample sizes. I will omit this aim from my proposal.






# 2. Power analysis for effect of imprinting on probability of symptoms lasting >= 14 d
Assumptions:

* Assume the baseline probability of symptoms lasting >= 14 d is 0.13 for H1N1 and about 0.11 for H3N2. These values are slightly lower than the overall percentage of cases with symptoms lasting >= 14 d in summary data.
* Assume probability of symptoms >= 14d is roughly equal for adults in the 70+ age group and for younger adults. This goes against the conventional wisdowm that older adults are at high risk of severe infection, but the FLU002 summary data suggest the oldest patients are actually less likely to have symptoms after 14 days than younger adults:
+ H1N1: 14.8% of adults under age 70 had symptoms >= 14 days, vs 11.1% of adults over age 70 with symptoms >= 14d
+ H3N2: 12.6% of adults under age 70 had symptoms >= 14 days, vs. 10% of adults over age 70 with symptoms >= 14d
* Assume individuals who lack imprinting protection are 1.25 times as likely (small effect size), 1.6 times as likely (moderate effect size), or 2 times as likely (large effect size) to have  symptoms >= 14d, in comparison to individuals protected by childhood imprinting.


## Simulate 1000 datasets, fit a logistic model to each, and then assess what fraction of times the imprinitng coefficient is significant
* Simulate data using the same number of cases in each age group as in the observed data.
* The fraction of itmes the imprinting coefficient is significant at p = 0.05 is equivalent to power.

#### Analysis using H1N1 parameters and sample sizes
```{r, echo = FALSE, cache=TRUE}
# Set assumed baselin probabilities
baseline.H1 = 0.148
baseline.H3 = 0.125
# Initialize matrix of results
H1.pvals = matrix(NA, n.sims, 3, dimnames = list(NULL, c('small', 'med', 'large')))

no.pts.H1 = c(626, 524, 370, 259, 99, 27) # How many patients in each age group?
bin.starts = c(18, 30, 40, 50, 60 ,70) # Define beginning and end of age bins
bin.ends   = c(29, 39, 49, 59, 69, 99)


## H1N1 simulation
for(ss in 1:n.sims){
# Draw patient ages, using the numbers of observations in each bin
simulated.ages = unlist(sapply(1:6, function(xx) sample(x = bin.starts[xx]:bin.ends[xx], size = no.pts.H1[xx], replace = TRUE)))

# Get the probability that each simulated patient lacks imprinting, based on their age
prob.lacks.imprinting = wo.H1.expanded[as.character(simulated.ages)]
# Using the above probabilities, perform a Bernoulli trial. 0 indicates no imprinting, 1 indicates imprinting
simulated.imprinting.status = sapply(prob.lacks.imprinting, function(pp) rbinom(n = 1, size = 1, prob = 1-pp))

# Set imprinting-specific modifiers
imp.small = imp.med = imp.large = rep(1, length(simulated.ages))
# For small effect size, prob of hospitalization is 1.25 as high in individuals lacking imprinting protection
imp.small[which(simulated.imprinting.status == 0)] = 1.25 
# For med effect size, prob of hospitalization is 1.6 as high in individuals lacking imprinting protection
imp.med[which(simulated.imprinting.status == 0)] = 1.75
# For large effect size, prob of hospitalization is 2 times as high in individuals lacking imprinting protection
imp.large[which(simulated.imprinting.status == 0)] = 2.25

# Set age-specific modifier (prob of hospitalization is equal for those over age 70)
age.mod = rep(1, length(simulated.ages))
age.mod[which(simulated.ages >= 70)] = 1

# Calculate probabilities of symptoms >= 14d based on age and imprinting status
p.symp = cbind(baseline.H1*imp.small*age.mod, baseline.H1*imp.med*age.mod, baseline.H1*imp.large*age.mod); colnames(p.symp) = c('small', 'med', 'large')

# Perform a Bernoulli trial for each simulated patient to determine if they are hospitalized or not
sim.duration.status = p.symp*0 # Initialize
for(ii in 1:length(p.symp)){
  sim.duration.status[ii] = rbinom(1, 1, p.symp[ii])
}

# Fit a logistic model to simulated data
small.fit = glm(sim.duration.status[,1] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
med.fit = glm(sim.duration.status[,2] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
large.fit = glm(sim.duration.status[,3] ~ simulated.ages + prob.lacks.imprinting, family = binomial)

H1.pvals[ss, 1] = summary(small.fit)$coefficients[3, 4]
H1.pvals[ss, 2] = summary(med.fit)$coefficients[3, 4]
H1.pvals[ss, 3] = summary(large.fit)$coefficients[3, 4]
}
```

Power: what % of runs gave a significant result for small, med and large effect sizes?
```{r, echo = FALSE}
apply(H1.pvals, 2, function(xx) sum(xx <= 0.05))/n.sims
```




#### Analysis using H3N2 parameters and sample sizes
```{r, echo = FALSE, cache = TRUE}
no.pts.H3 = c(497, 518, 422, 307, 178, 90) # How many patients in each age group?
bin.starts = c(18, 30, 40, 50, 60 ,70) # Define beginning and end of age bins
bin.ends   = c(29, 39, 49, 59, 69, 99)

# Initialize matrix of results
H3.pvals = matrix(NA, n.sims, 3, dimnames = list(NULL, c('small', 'med', 'large')))

for(ss in 1:n.sims){
# Draw patient ages, using the numbers of observations in each bin
simulated.ages = unlist(sapply(1:6, function(xx) sample(x = bin.starts[xx]:bin.ends[xx], size = no.pts.H3[xx], replace = TRUE)))

# Get the probability that each simulated patient lacks imprinting, based on their age
prob.lacks.imprinting = wo.H3.expanded[as.character(simulated.ages)]
# Using the above probabilities, perform a Bernoulli trial. 0 indicates no imprinting, 1 indicates imprinting
simulated.imprinting.status = sapply(prob.lacks.imprinting, function(pp) rbinom(n = 1, size = 1, prob = 1-pp))

# Set imprinting-specific modifiers
imp.small = imp.med = imp.large = rep(1, length(simulated.ages))
# For small effect size, prob of hospitalization is 1.25 as high in individuals lacking imprinting protection
imp.small[which(simulated.imprinting.status == 0)] = 1.25 
# For med effect size, prob of hospitalization is 1.6 as high in individuals lacking imprinting protection
imp.med[which(simulated.imprinting.status == 0)] = 1.75
# For large effect size, prob of hospitalization is 2 times as high in individuals lacking imprinting protection
imp.large[which(simulated.imprinting.status == 0)] = 2.25

# Set age-specific modifier (prob of hospitalization is equal for those over age 70)
age.mod = rep(1, length(simulated.ages))
age.mod[which(simulated.ages >= 70)] = 1

# Calculate probabilities of symptoms >= 14d based on age and imprinting status
p.symp = cbind(baseline.H3*imp.small*age.mod, baseline.H3*imp.med*age.mod, baseline.H3*imp.large*age.mod); colnames(p.symp) = c('small', 'med', 'large')

# Perform a Bernoulli trial for each simulated patient to determine if they are hospitalized or not
sim.duration.status = p.symp*0 # Initialize
for(ii in 1:length(p.symp)){
  sim.duration.status[ii] = rbinom(1, 1, p.symp[ii])
}

# Fit a logistic model to simulated data
small.fit = glm(sim.duration.status[,1] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
med.fit = glm(sim.duration.status[,2] ~ simulated.ages + prob.lacks.imprinting, family = binomial)
large.fit = glm(sim.duration.status[,3] ~ simulated.ages + prob.lacks.imprinting, family = binomial)

H3.pvals[ss, 1] = summary(small.fit)$coefficients[3, 4]
H3.pvals[ss, 2] = summary(med.fit)$coefficients[3, 4]
H3.pvals[ss, 3] = summary(large.fit)$coefficients[3, 4]
}
```

Power: what % of runs gave a significant result for small, med and large effect sizes?
```{r, echo = FALSE}
apply(H3.pvals, 2, function(xx) sum(xx <= 0.05))/n.sims
```

#### Conclusion: 
