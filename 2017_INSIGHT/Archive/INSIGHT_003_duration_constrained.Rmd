---
title: "003_symdur"
author: "Katie Gostic"
date: "11/1/2017"
output: html_document
---

#### Note: symdur only contains info on the duration of symptoms prior to admission, so all these analyses may be useless. Seems like much of the total duration of symptoms data is missing.

```{r setup, include=FALSE}
setwd('~/Dropbox/R/2017_INSIGHT/')
rm(list = ls())
source('Import_FLU003.R')
set.seed(91)
```
Notes on data formatting from Deborah Wentworth:

* symdur is symptom duration (days) prior to enrollment
* date info is for enrollment date
* fluvac6 and fluvac12 are flu vaccination in last 6 or last 12 months
* anyvac combines values from fluvac6 and fluvac12, whichever was collected for a given patient is reported.
* anyav is use of antivirals at any time
* anydx is any diagnosis in the medical history section
* flutype is subtype: 1=H1N1, 2=H3N2, 3=flu B, 4=PCR negative, 5=Inf A, subtype unknown, and 6=coinfection with multiple strains
* resolved is symptom resolution within 14 days
* country code is the 3 letter code for country of enrollment - think the abbreviations will be obvious


Notes on duration of symptoms:
Currently using symdur here, because I want to do this analysis on the continuous duration of symptoms.
But I'm waiting for an email from Deb clarifying whether or not this variable represents total duration of symptoms or just duration prior to enrollment.



#### Visualize the relationship between age and duration of symptoms
```{r warning = FALSE, echo = FALSE}
# Select only cases with confirmed H1N1
valid = dat.003[dat.003$H1N1 == 1 & ! is.na(dat.003$H1N1), ]
plot(jitter(valid$age), jitter(valid$symdur), ylim = c(1, 30), xlim = c(10, 100), xlab = 'age', ylab = 'symdur', col = 'darkslateblue', main = 'H1N1: Duration of symptoms by age', cex = .7)
cor.test(valid$age, valid$symdur, method = 'spearman')
```

There is a trend toward a very weak positive correlation here, but looking at the data shows that it's not very strong.


#### Visualize the relationship between age and prob of H3N2 infection
```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
plot(jitter(valid$age), jitter(valid$symdur), ylim = c(0, 30), xlim = c(10, 100), xlab = 'age', ylab = 'symdur', col = 'firebrick1', main = 'H3N2: Duration of symptoms by age', cex = .7)
cor.test(valid$age, valid$symdur, method = 'spearman')
```

Results suggest a weak, positive correlation, although this may be influenced by outliers.

#### Visualize the relationship between country and symptom duration
H1N1

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$H1N1), ]
plot(factor(valid$country), jitter(valid$symdur),  xlab = '', ylab = 'symdur', col = 'lightblue', main = 'H1N1: Duration of symptoms by country', cex = .7, las = 3)
```

H3N2

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
plot(factor(valid$country), jitter(valid$symdur),  xlab = '', ylim = c(0, 60), ylab = 'symdur', col = 'pink3', main = 'H3N2: Symptom duration by country', cex = .7, las = 3)
```

# No clear effect of country

#### Visualize the relationship between season and symptom duration

H1N1

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$H1N1), ]
plot(factor(valid$season), jitter(valid$symdur),  xlab = '', ylab = 'symdur', col = 'lightblue', main = 'H1N1: Symptom duration by season', cex = .7, las = 3)
```

No clear effect of season.



H3N2

```{r warning = FALSE, echo = FALSE}
valid = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$H3N2), ]
plot(factor(valid$season), jitter(valid$symdur),  xlab = '', ylim = c(0, 60), ylab = 'symdur', col = 'pink3', main = 'H3N2: Symptom duraiton by season', cex = .7, las = 3)
```



## Set up a logistic regression that includes the following predictors:
* age
* imprinting status
* vaccination status
* antiviral use
* season
* country





### Clean data for fitting
```{r echo = FALSE}
H1N1.model.dat = dat.003[dat.003$H1N1 == 1 & !is.na(dat.003$anyicu) & !is.na(dat.003$H1N1), ]

# Group countries with 20 or fewer valid cases into "other"
table(H1N1.model.dat$country)
H1N1.model.dat$country[which(H1N1.model.dat$country %in% c('Austria', 'Chile', 'China', 'Norway', 'Peru', 'Poland', 'Singapore'))] = 'Other'

# Convert blocking variables to factors
H1N1.model.dat$anyav = factor(H1N1.model.dat$anyav)
H1N1.model.dat$anyvac = factor(H1N1.model.dat$anyvac)
H1N1.model.dat$anydx = factor(H1N1.model.dat$anydx)
H1N1.model.dat$country = factor(H1N1.model.dat$country)
H1N1.model.dat$season = factor(H1N1.model.dat$season)

# Split into training and test data
nrow(H1N1.model.dat)
test.inds = sample(1:nrow(H1N1.model.dat), size = 77, replace = FALSE)
train.H1N1 = H1N1.model.dat[-test.inds, ]
test.H1N1 = H1N1.model.dat[test.inds, ]


# H3N2
H3N2.model.dat = dat.003[dat.003$H3N2 == 1 & !is.na(dat.003$anyicu) & !is.na(dat.003$H3N2), ]

# Group countries with 20 or fewer valid cases into "other"
table(H3N2.model.dat$country)
H3N2.model.dat$country[which(H3N2.model.dat$country %in% c('Belgium', 'China', 'Peru'))] = 'Other'

# Convert blocking variables to factors
H3N2.model.dat$anyav = factor(H3N2.model.dat$anyav)
H3N2.model.dat$anyvac = factor(H3N2.model.dat$anyvac)
H3N2.model.dat$anydx = factor(H3N2.model.dat$anydx)
H3N2.model.dat$country = factor(H3N2.model.dat$country)
H3N2.model.dat$season = factor(H3N2.model.dat$season)

# Split into training and test data
nrow(H3N2.model.dat)
test.inds = sample(1:nrow(H3N2.model.dat), size = 79, replace = FALSE)
train.H3N2 = H3N2.model.dat[-test.inds, ]
test.H3N2 = H3N2.model.dat[test.inds, ]



# Concatenate H3N2 and H1N1 data
test = rbind(test.H1N1, test.H3N2)
test$H1.valid = test$H3.valid = 0
test$H1.valid[1:nrow(test.H1N1)] = 1
test$H3.valid[(nrow(test.H1N1)+1):nrow(test)] = 1
test$H1.valid = factor(test$H1.valid)
test$H3.valid = factor(test$H3.valid)

train = rbind(train.H1N1, train.H3N2)
train$H1.valid = train$H3.valid = 0
train$H1.valid[1:nrow(train.H1N1)] = 1
train$H3.valid[(nrow(train.H1N1)+1):nrow(train)] = 1
train$H1.valid = factor(train$H1.valid)
train$H3.valid = factor(train$H3.valid)

# Create a master outcome column
test$infected = c(test.H1N1$H1N1, test.H3N2$H3N2)
train$infected = c(train.H1N1$H1N1, train.H3N2$H3N2)

# Create a master protection column
test$p.protected = c(test.H1N1$p.g1.protection, test.H3N2$p.g2.protection)
train$p.protected = c(train.H1N1$p.g1.protection, train.H3N2$p.g2.protection)

```


### First fit a model where the only independent variable is age
Treat vaccination, antivial use, underlying symptoms, country and season as blocking variables with fixed effects
```{r}
library(splines)
## H1N1 fit to medical history only (no effect of country, season, age or imprinting)
fit00 = glm(symdur ~ anyav + anydx  + H3.valid*anyvac, data = train)
summary(fit00)

## H1N1 fit to country, season and medical history only (no effect of age or imprinting)  
fit0 = glm(symdur ~ anyav + anydx + country + H3.valid*season + H3.valid*anyvac, data = train)
summary(fit0)

## H1N1 fit to age only, plus fixed effects of vaccination, av use, underlying conditions, country and season
fit1 = glm(symdur ~ ns(age, knots = 65) + anyav + anydx + country + H3.valid*season + H3.valid*anyvac, data = train)
summary(fit1)

## H1N1 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, country and season
fit2 = glm(symdur ~ ns(age, knots = 65) +p.protected + anyav + anydx + country + H3.valid*season + H3.valid*anyvac, data = train)
summary(fit2)

## H1N1 fit to age only, plus fixed effects of vaccination, av use, underlying conditions NO COUNTRY AND SEASON
fit3 = glm(symdur ~ ns(age, knots = 65) + anyav + anydx  + H3.valid*anyvac, data = train)
summary(fit3)

## H1N1 fit to age plus imprinting, plus fixed effects of vaccination, av use, underlying conditions, NO COUNTRY AND SEASON
fit4 = glm(symdur ~ ns(age, knots = 65) + p.protected + anyav + anydx + H3.valid*anyvac, data = train)
summary(fit4)


## Plot the fits for each model side by side
par(mfrow = c(1, 2), las = 3, mar = c(6, 6, 6, 3), cex.axis = .7)
library(gam)
plot.gam(fit00, se = T, col = 'darkslateblue', main = 'Simplified Baseline')
plot.gam(fit0, se = T, col = 'darkslateblue', main = 'Baseline')
plot.gam(fit1, se = T, col = 'darkslateblue', main = 'Baseline + age + imp')
plot.gam(fit2, se = T, col = 'darkslateblue', main = 'Baseline + age + imp')
plot.gam(fit3, se = T, col = 'darkslateblue', main = 'Simple baseline + age + imp')
plot.gam(fit4, se = T, col = 'darkslateblue', main = 'Simple baseline + age + imp')

pdf('003Symdur_constrained.pdf')
plot.gam(fit4, se = T, col = 'darkslateblue', main = 'Simple baseline + age + imp')
dev.off()

# Predict probs for each patient
pred00 = predict(fit00, newdata = test)
pred0 = predict(fit0, newdata = test)
pred1 = predict(fit1, newdata = test)
pred2 = predict(fit2, newdata = test)
pred3 = predict(fit3, newdata = test)
pred4 = predict(fit4, newdata = test)
  
# Estimate the simulated error rate
MSE = numeric(6); names(MSE) = c('simple.baseline', 'baseline', 'baeline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')
MSE[1] = mean((pred00 - test$symdur)^2)
MSE[2] = mean((pred0 - test$symdur)^2)
MSE[3] = mean((pred1 - test$symdur)^2)
MSE[4] = mean((pred2 - test$symdur)^2)
MSE[5] = mean((pred3 - test$symdur)^2)
MSE[6] = mean((pred4 - test$symdur)^2)
sort(MSE)

AIC = c(fit00$aic, fit0$aic, fit1$aic, fit2$aic, fit3$aic, fit4$aic); names(AIC) =  c('simple.baseline', 'baseline', 'baeline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')
del.AIC = sort(AIC - min(AIC))
del.AIC

load('master.AIC.table.constrained.RData')
master.AIC.table['003Symdur',  c('simple.baseline', 'baseline', 'baseline+age', 'baseline+age+imp', 'simple.baseline+age', 'simple.baseline+age+imp')] = AIC - min(AIC)
save(master.AIC.table, file = 'master.AIC.table.constrained.RData')
rm(master.AIC.table)
```




